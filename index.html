<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 IoT Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
/* CSS tetap sama */
:root {
  --bg:#0f172a;
  --card:#1e293b;
  --dark:#020617;
  --primary:#38bdf8;
  --success:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Arial;
  background:var(--bg);
  color:#e5e7eb;
}

/* LOGIN */
#loginPage{
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-box{
  background:var(--card);
  padding:40px;
  width:340px;
  border-radius:16px;
  box-shadow:0 0 25px rgba(0,0,0,.5);
}
.login-box h2{text-align:center}
.login-box input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:none;
}
.login-box button{
  width:100%;
  padding:12px;
  background:var(--primary);
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
#error{color:#f87171;text-align:center}

/* DASHBOARD */
#dashboardPage{display:none;animation:fade .4s ease}
@keyframes fade{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:translateY(0)}
}

header{
  background:var(--dark);
  padding:14px 25px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
nav button{
  margin-left:6px;
  padding:8px 14px;
  border-radius:6px;
  border:none;
  background:#334155;
  color:white;
  cursor:pointer;
}

.container{padding:25px}

.total-box{
  background:var(--dark);
  padding:22px;
  border-radius:18px;
  text-align:center;
  margin-bottom:25px;
}
.total-box h1{
  margin:5px 0 0;
  font-size:48px;
  color:var(--primary);
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:18px;
}
.card{
  background:var(--card);
  padding:18px;
  border-radius:14px;
  text-align:center;
  cursor:pointer;
}
.count{
  font-size:30px;
  color:var(--success);
}

/* New lane layout */
.lane{
  display:flex;
  flex-direction:column;
  height:150px;
  justify-content:space-between;
}
.lane .top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.lane .title{font-weight:700; text-align:left}
.lane .avg{font-weight:700; text-align:center}
.lane .eff{font-weight:700; text-align:right}
.lane .target-box{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px;
  border-radius:8px;
  background:rgba(255,255,255,0.03);
}
.lane .bottom{font-weight:700; text-align:left}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #334155;
  font-size:14px;
}

footer{
  text-align:center;
  padding:10px;
  font-size:13px;
  color:#94a3b8;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-box">
    <h2>USER LOGIN</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="doLogin()">LOGIN</button>
    <p id="error"></p>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage">

<header>
  <b>Total Hasil Produksi Sardines PHI</b>
  <nav>
<select id="machineSelect">
  <option value="machine01">Machine 01</option>
  <option value="machine02">Machine 02</option>
  <option value="machine03">Machine 03</option>
  <option value="machine04">Machine 04</option>
  <option value="machine05">Machine 05</option>
  <option value="machine06">Machine 06</option>
</select>

    <span id="clock"></span>
    <button onclick="showDashboard()">Dashboard</button>
    <button onclick="showHistory()">History</button>
    <button onclick="saveData()">Simpan</button>
    <button onclick="resetCounter()">Reset</button>
    <button onclick="logout()">Logout</button>
  </nav>
</header>

<div class="container" id="dashboardView">
  <div class="total-box">
    <div>Total Produksi</div>
    <h1 id="total">0</h1>
  </div>
  <div class="grid" id="cards"></div>
</div>

<div class="container" id="historyView" style="display:none">
  <h2>Data Tersimpan</h2>
  <table id="historyTable">
    <tr><th>Waktu</th><th>Total</th><th>Detail</th></tr>
  </table>
</div>

<!-- TAMBAHAN: VIEW UNTUK HISTORY PER SENSOR -->
<div class="container" id="sensorHistoryView" style="display:none">
  <h2>History Sensor <span id="sensorTitle"></span></h2>
  <button onclick="showDashboard()">Kembali ke Dashboard</button>
  <table id="sensorHistoryTable">
    <tr><th>Waktu</th><th>Nilai Sensor</th></tr>
  </table>
</div>

<footer>Status MQTT: <span id="status">Initializing...</span> | Firebase: <span id="firebaseStatus">Initializing...</span></footer>
</div>

<script type="module">
// TAMBAHAN: Import Firebase SDK v12.7.0
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAcA7CYQqoig7eVaMbopIQpq9EWn1mVudA",
  authDomain: "iot-phi.firebaseapp.com",
  databaseURL: "https://iot-phi-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "iot-phi",
  storageBucket: "iot-phi.firebasestorage.app",
  messagingSenderId: "284686032428",
  appId: "1:284686032428:web:82bec581d6c9d1a3193b89",
  measurementId: "G-HWD5C417GN"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

/* ================= LOGIN ================= */
function doLogin(){
  if(username.value==="admin" && password.value==="admin123"){
    sessionStorage.setItem("login","1");
    location.reload();
  }else{
    error.innerText="Username atau password salah";
  }
}
function logout(){
  sessionStorage.clear();
  location.reload();
}
window.onload=()=>{
  if(sessionStorage.getItem("login")==="1"){
    loginPage.style.display="none";
    dashboardPage.style.display="block";
    generateAllCards();
    loadLastCacheFromFirebase();  // Load dari Firebase
    // Start daily scheduler untuk autosave + reset pada jam 08:20
    scheduleDailyAt(8,20, saveAndResetAuto);
  }
};

/* ================= CLOCK ================= */
setInterval(()=>{
  clock.innerText=new Date().toLocaleString();
},1000);

/* ================= VIEW ================= */
function showDashboard(){
  dashboardView.style.display="block";
  historyView.style.display="none";
  sensorHistoryView.style.display="none";
}
function showHistory(){
  dashboardView.style.display="none";
  historyView.style.display="block";
  sensorHistoryView.style.display="none";
  loadHistoryFromFirebase();  // Load dari Firebase
}

function showSensorHistory(sensorId){
  dashboardView.style.display="none";
  historyView.style.display="none";
  sensorHistoryView.style.display="block";
  document.getElementById("sensorTitle").innerText = `LINE ${sensorId}`;
  loadSensorHistoryFromFirebase(sensorId);  // Load dari Firebase
}

/* ================= GENERATE SEMUA SENSOR CARDS ================= */
function generateAllCards(){
  cards.innerHTML = '';
  for(let i=1;i<=14;i++){
    cards.innerHTML += `
      <div class="card" onclick="showSensorHistory(${i})">
        <div class="lane">
          <div class="top">
            <div class="title">LINE ${i}</div>
            <div class="avg" id="avgL${i}">0</div>
            <div class="eff" id="effL${i}">0%</div>
          </div>
          <div class="target-box">
            <div>TARGET</div>
            <div id="targetL${i}">0</div>
          </div>
          <div class="bottom">
            SPEED MACHINE : <span id="speedL${i}">0 /min</span>
            <div style="display:none" id="L${i}">0</div>
          </div>
        </div>
      </div>`;
  }
}

/* ================= MQTT ================= */
let latestCounter = {};  // Gabungan counter dari semua mesin

// Tambahan untuk throttling update UI
let updateTimeout = null;
const UPDATE_INTERVAL = 500;  // Update UI setiap 500ms (sesuaikan jika perlu)

const client = mqtt.connect(
  "wss://c836c913dd894d7db71ce06137b51f4e.s1.eu.hivemq.cloud:8884/mqtt",
  {
    username: "adminphi123",
    password: "Phi12345",
    reconnectPeriod: 2000
  }
);

client.on("connect", () => {
  document.getElementById("status").innerText = "Connected";
  // Subscribe ke semua topik counter mesin
  for(let i=1; i<=6; i++){
    const machine = `machine${i.toString().padStart(2,'0')}`;
    client.subscribe(`iot/esp32/${machine}/counter`);
  }
});

client.on("message", (topic, msg) => {
  const data = JSON.parse(msg.toString());
  const machine = topic.split('/')[2];  // Extract machine from topic, e.g., "machine01"

  // Simpan ke Firebase per mesin
  saveCacheToFirebase(machine, data);

  // ===== PROTEKSI DATA RESET AKIBAT ESP MATI =====
  const isAllZero = Object.values(data.counter).every(v => v === 0);
  if(isAllZero && data.reset_source !== "web"){
    console.warn("IGNORE ESP REBOOT RESET for " + machine);
    return;
  }
  // ==============================================

  // Update counter untuk mesin ini
  Object.keys(data.counter).forEach(key => {
    latestCounter[key] = data.counter[key];
    // push sample untuk per-line history (used to compute speed/avg)
    pushLineSample(key, data.counter[key]);
  });

  // Throttle update UI: Jadwalkan update hanya jika belum dijadwalkan
  if (!updateTimeout) {
    updateTimeout = setTimeout(() => {
      updateUI();
      updateTimeout = null;  // Reset setelah update
    }, UPDATE_INTERVAL);
  }
});

function updateUI(){
  console.time('updateUI');  // Untuk monitoring performa
  let total = 0;
  for (let i = 1; i <= 14; i++) {
    const val = latestCounter[`L${i}`] || 0;
    document.getElementById(`L${i}`).innerText = val;
    total += val;
  }
  document.getElementById("total").innerText = total;
  console.timeEnd('updateUI');  // Akhiri monitoring
}

/* ================= SAVE DATA KE FIREBASE ================= */
function saveData(){
  const entry = {
    time: new Date().toLocaleString(),
    total: total.innerText,
    counter: latestCounter
  };
  const historyRef = ref(database, 'history');
  // Return the push promise so callers can chain (used by auto-save)
  return push(historyRef, entry).then(() => {
    alert("Data disimpan ke Firebase");
  }).catch((error) => {
    console.error("Error saving data:", error);
    throw error;
  });
}

// Per-line history + scheduling helpers
let lineHistory = {}; // e.g. { L1: [{t:ts, v:val}, ...] }
let lastResetTime = null;

function setLastResetTime(d){
  lastResetTime = d instanceof Date ? d : new Date(d);
  localStorage.setItem('lastResetTime', lastResetTime.toISOString());
}

function loadLastResetTime(){
  const s = localStorage.getItem('lastResetTime');
  if(s){ lastResetTime = new Date(s); return; }
  // fallback: compute most recent 08:20
  const now = new Date();
  let cand = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 20, 0, 0);
  if(cand > now) cand.setDate(cand.getDate() - 1);
  lastResetTime = cand;
  localStorage.setItem('lastResetTime', lastResetTime.toISOString());
}

function pushLineSample(key, value){
  if(!lineHistory[key]) lineHistory[key]=[];
  const t = Date.now();
  const arr = lineHistory[key];
  arr.push({t, v: value});
  // prune older than 10 minutes
  const tenMin = 10*60*1000;
  while(arr.length && (t - arr[0].t) > tenMin) arr.shift();
}

function computeSpeedPerMin(key){
  const arr = lineHistory[key] || [];
  if(arr.length < 2) return 0;
  const first = arr[0];
  const last = arr[arr.length-1];
  const delta = last.v - first.v;
  const minutes = (last.t - first.t) / 60000;
  if(minutes <= 0) return 0;
  return delta / minutes; // per minute
}

function computeAvgValue(key){
  const arr = lineHistory[key] || [];
  if(!arr.length) return 0;
  const sum = arr.reduce((s,x)=>s + x.v,0);
  return sum / arr.length;
}

function computeTargetForLine(key){
  // target = speedPerMin * elapsedMinutes since lastResetTime
  if(!lastResetTime) loadLastResetTime();
  const speed = computeSpeedPerMin(key);
  const now = Date.now();
  const elapsedMin = Math.max(0, (now - lastResetTime.getTime())/60000);
  return Math.round(speed * elapsedMin);
}

// Save then reset helpers for automatic daily run
function resetAllMachines(){
  for(let i=1;i<=6;i++){
    const machine = `machine${i.toString().padStart(2,'0')}`;
    const targetCmd = `iot/esp32/${machine}/cmd`;
    const payload = JSON.stringify({ cmd: "RESET", reset_source: "web" });
    client.publish(targetCmd, payload);
  }
  setLastResetTime(new Date());
}

function saveAndResetAuto(){
  saveData().then(()=>{
    // setelah berhasil menyimpan, kirim perintah reset ke semua mesin
    resetAllMachines();
  }).catch((err)=>{
    console.error('Auto save failed, skip reset:', err);
  });
}

// Schedule a daily action at specific hour/minute (local time)
function scheduleDailyAt(hour, minute, action){
  const now = new Date();
  let next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0, 0);
  if(next <= now) next.setDate(next.getDate() + 1);
  const msUntilNext = next - now;
  setTimeout(() => {
    try{ action(); }catch(e){ console.error('Scheduled action error:', e); }
    // set interval every 24h after first run
    setInterval(() => { try{ action(); }catch(e){ console.error('Scheduled action error:', e); } }, 24*60*60*1000);
  }, msUntilNext);
}

// Integrate scheduler: jalankan setiap hari jam 08:20 ketika user sudah login
// Dipanggil pada window.onload setelah dashboard ditampilkan

function saveCacheToFirebase(machine, data){
  const cacheRef = ref(database, `lastCache/${machine}`);
  // Cek apakah data berubah sebelum save (untuk mengurangi beban)
  get(cacheRef).then((snapshot) => {
    const existing = snapshot.val();
    if (JSON.stringify(existing) !== JSON.stringify(data)) {
      set(cacheRef, data).then(() => {
        document.getElementById("firebaseStatus").innerText = "Synced";
      }).catch((error) => {
        console.error("Error saving cache:", error);
        document.getElementById("firebaseStatus").innerText = "Error";
      });
    }
  }).catch((error) => {
    console.error("Error checking cache:", error);
  });
}

function loadLastCacheFromFirebase(){
  const cacheRef = ref(database, 'lastCache');
  get(cacheRef).then((snapshot) => {
    const cached = snapshot.val();
    if(cached){
      Object.keys(cached).forEach(machine => {
        const data = cached[machine];
        if(data && data.counter){
          Object.keys(data.counter).forEach(key => {
            latestCounter[key] = data.counter[key];
            // initialize history with cached value
            pushLineSample(key, data.counter[key]);
          });
        }
      });
      updateUI();
    }
  }).catch((error) => {
    console.error("Error loading cache:", error);
  });
}

function loadHistoryFromFirebase(){
  historyTable.innerHTML = "<tr><th>Waktu</th><th>Total</th><th>Detail</th></tr>";
  const historyRef = ref(database, 'history');
  get(historyRef).then((snapshot) => {
    const history = snapshot.val();
    if(history){
      Object.values(history).forEach(h => {
        historyTable.innerHTML += `
          <tr>
            <td>${h.time}</td>
            <td>${h.total}</td>
            <td>${JSON.stringify(h.counter)}</td>
          </tr>`;
      });
    }
  }).catch((error) => {
    console.error("Error loading history:", error);
  });
}

function loadSensorHistoryFromFirebase(sensorId){
  sensorHistoryTable.innerHTML = "<tr><th>Waktu</th><th>Nilai Sensor</th></tr>";
  const historyRef = ref(database, 'history');
  get(historyRef).then((snapshot) => {
    const history = snapshot.val();
    if(history){
      Object.values(history).forEach(h => {
        const sensorValue = h.counter[`L${sensorId}`] || 0;
        sensorHistoryTable.innerHTML += `
          <tr>
            <td>${h.time}</td>
            <td>${sensorValue}</td>
          </tr>`;
      });
    }
  }).catch((error) => {
    console.error("Error loading sensor history:", error);
  });
}

/* ================= RESET ================= */
function resetCounter(){
  const selectedMachine = document.getElementById("machineSelect").value;
  const targetCmd = `iot/esp32/${selectedMachine}/cmd`;
  client.publish(targetCmd, "RESET");
}

// Expose functions to global scope for onclick
window.doLogin = doLogin;
window.logout = logout;
window.showDashboard = showDashboard;
window.showHistory = showHistory;
window.showSensorHistory = showSensorHistory;
window.saveData = saveData;
window.resetCounter = resetCounter;
</script>

</body>
</html>