<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ESP32 IoT Dashboard</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<style>
:root{
  --bg:#0f172a;--card:#1e293b;--dark:#020617;
  --primary:#38bdf8;--success:#22c55e;
}
*{box-sizing:border-box}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:#e5e7eb}
#loginPage{height:100vh;display:flex;justify-content:center;align-items:center}
.login-box{background:var(--card);padding:40px;width:340px;border-radius:16px}
.login-box input{width:100%;padding:12px;margin-bottom:12px;border-radius:8px;border:none}
.login-box button{width:100%;padding:12px;background:var(--primary);border:none;border-radius:8px}
#error{color:#f87171;text-align:center}
#dashboardPage{display:none}
header{background:var(--dark);padding:14px 25px;display:flex;justify-content:space-between}
nav button{margin-left:6px;padding:8px 14px;border:none;border-radius:6px}
.container{padding:25px}
.total-box{background:var(--dark);padding:22px;border-radius:18px;text-align:center}
.total-box h1{font-size:48px;color:var(--primary)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:18px}
.card{background:var(--card);padding:18px;border-radius:14px;text-align:center}
.count{font-size:30px;color:var(--success)}
footer{text-align:center;padding:10px;font-size:13px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPage">
  <div class="login-box">
    <h2>IoT Dashboard Login</h2>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <button onclick="doLogin()">LOGIN</button>
    <p id="error"></p>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage">
<header>
  <b>ESP32 Proximity Counter</b>
  <nav>
    <select id="machineSelect"></select>
    <span id="clock"></span>
    <button onclick="resetCounter()">Reset</button>
    <button onclick="logout()">Logout</button>
  </nav>
</header>

<div class="container">
  <div class="total-box">
    <div>Total Counter</div>
    <h1 id="total">0</h1>
  </div>
  <div class="grid" id="cards"></div>
</div>

<footer>Status MQTT: <span id="status">Init</span></footer>
</div>

<script>
/* ================= LOGIN ================= */
function doLogin(){
  if(username.value==="admin"&&password.value==="admin123"){
    sessionStorage.setItem("login","1");location.reload();
  }else error.innerText="Login salah";
}
function logout(){sessionStorage.clear();location.reload()}
window.onload=()=>{
  if(sessionStorage.getItem("login")==="1"){
    loginPage.style.display="none";
    dashboardPage.style.display="block";
    loadLastCache();
  }
};

/* ================= CLOCK ================= */
setInterval(()=>clock.innerText=new Date().toLocaleString(),1000);

/* ================= SENSOR UI ================= */
for(let i=1;i<=12;i++){
  cards.innerHTML+=`<div class="card">Sensor ${i}<div class="count" id="s${i}">0</div></div>`;
}

/* ================= MQTT ================= */
let activeMachine=null;
let allowZeroOnce=false;
let latestCounter={};

const client=mqtt.connect(
"wss://c836c913dd894d7db71ce06137b51f4e.s1.eu.hivemq.cloud:8884/mqtt",
{username:"adminphi123",password:"Phi12345",reconnectPeriod:2000}
);

client.on("connect",()=>{
  status.innerText="Connected";
});

client.on("message",(topic,msg)=>{
  const data=JSON.parse(msg.toString());
  const machine=topic.split("/")[2];
  const isZero=Object.values(data.counter||{}).every(v=>v===0);

  if(isZero && !allowZeroOnce){
    console.warn("ESP reboot ignored");
    return;
  }
  allowZeroOnce=false;

  saveCache(machine,data);
  if(!activeMachine){setActiveMachine(machine)}

  if(machine!==activeMachine)return;

  renderData(data.counter);
});

/* ================= MACHINE ================= */
function setActiveMachine(m){
  activeMachine=m;
  machineSelect.value=m;
  subscribeMachine(m);
  loadCacheUI(m);
}
function subscribeMachine(m){
  client.subscribe(`iot/esp32/${m}/proximity_counter`);
}
machineSelect.onchange=e=>{
  setActiveMachine(e.target.value);
}

/* ================= RENDER ================= */
function renderData(counter){
  let total=0;
  for(let i=1;i<=12;i++){
    const v=counter[`s${i}`]||0;
    document.getElementById(`s${i}`).innerText=v;
    total+=v;
  }
  total.innerText=total;
}

/* ================= RESET ================= */
function resetCounter(){
  allowZeroOnce=true;
  client.publish(`iot/esp32/${activeMachine}/cmd`,"RESET");
}

/* ================= CACHE ================= */
function cacheKey(m){return "cache_"+m}
function saveCache(m,d){localStorage.setItem(cacheKey(m),JSON.stringify(d))}
function loadCache(m){
  const r=localStorage.getItem(cacheKey(m));
  return r?JSON.parse(r):null;
}
function loadCacheUI(m){
  const c=loadCache(m);if(!c)return;
  renderData(c.counter);
}
function loadLastCache(){
  const k=Object.keys(localStorage).filter(k=>k.startsWith("cache_"));
  if(!k.length)return;
  const m=k[0].replace("cache_","");
  machineSelect.innerHTML=k.map(x=>{
    const v=x.replace("cache_","");
    return `<option>${v}</option>`;
  }).join("");
  setActiveMachine(m);
}
</script>
</body>
</html>
