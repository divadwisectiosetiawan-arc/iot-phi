<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasific Harvest Indonesia - IoT Dashboard</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <style>
        :root { --bg:#0f172a; --card:#1e293b; --dark:#020617; --primary:#38bdf8; --success:#22c55e; --danger:#ef4444; --text:#e5e7eb; --border:#334155; }
        *{box-sizing:border-box} body{margin:0;font-family:"Segoe UI",sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}
        
        /* LOGO & HEADER */
        .login-logo{max-width:150px;display:block;margin:0 auto 20px auto}
        .header-brand{display:flex;align-items:center;gap:15px}
        .header-logo{height:45px;width:auto}
        
        /* LOGIN */
        #loginPage{height:100vh;display:flex;justify-content:center;align-items:center;position:fixed;top:0;left:0;right:0;bottom:0;z-index:999;background:var(--bg)}
        .login-box{background:var(--card);padding:40px;width:350px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.5);border:1px solid var(--border);text-align:center}
        .login-box input{width:100%;padding:12px;margin-bottom:15px;border-radius:8px;border:1px solid var(--border);background:var(--dark);color:#fff;outline:0}
        .login-box button{width:100%;padding:12px;background:var(--primary);color:var(--dark);border:0;border-radius:8px;font-weight:700;cursor:pointer}
        
        /* DASHBOARD */
        #dashboardPage{display:none}
        header{background:var(--dark);padding:15px 25px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
        nav{display:flex;gap:10px;align-items:center}
        nav button, nav select{padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:#fff;cursor:pointer}
        .btn-save{background:var(--success)!important;border:0} .btn-reset{background:var(--danger)!important;border:0}
        
        .container{padding:25px;max-width:1400px;margin:0 auto}
        .total-box{background:linear-gradient(135deg,var(--dark),var(--card));padding:30px;border-radius:16px;text-align:center;margin-bottom:30px;border:1px solid var(--border);box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
        .total-box h1{margin:10px 0 0;font-size:4rem;color:var(--primary);font-weight:700}
        
        /* SETTING BOX (BARU) */
        .setting-box { background: #334155; padding: 10px; border-radius: 8px; display: inline-flex; align-items: center; gap: 10px; margin-top: 15px; }
        .setting-box input { width: 60px; padding: 5px; text-align: center; border-radius: 4px; border: none; }
        .status-blink { animation: blink 1s infinite; color: var(--success); font-weight: bold; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}
        .card{background:var(--card);padding:20px;border-radius:12px;border:1px solid var(--border);cursor:pointer;transition:.2s}
        .card:hover{transform:translateY(-5px);border-color:var(--primary)}
        .mini-table{width:100%;border-collapse:collapse} .mini-table th{text-align:left;color:#64748b;font-size:.75rem} .mini-table td{font-size:1.2rem;font-weight:600} .val-actual{color:var(--success);font-size:1.5rem!important}
        
        .table-responsive{overflow-x:auto;background:var(--card);border-radius:12px;border:1px solid var(--border)}
        table.full-table{width:100%;border-collapse:collapse;min-width:600px}
        .full-table th,.full-table td{padding:15px;text-align:left;border-bottom:1px solid var(--border)} .full-table th{background:var(--dark);color:var(--primary)}
        footer{margin-top:40px;text-align:center;padding:20px;font-size:.8rem;color:#64748b;border-top:1px solid var(--border)}
    </style>
</head>

<body>

<div id="loginPage">
    <div class="login-box">
        <img src="phi.png" alt="Logo" class="login-logo" onerror="this.style.display='none'">
        <h2>USER LOGIN</h2>
        <input id="username" type="text" placeholder="Username (admin)">
        <input id="password" type="password" placeholder="Password (admin123)">
        <button onclick="doLogin()">LOGIN</button>
        <p id="error" style="color:var(--danger)"></p>
    </div>
</div>

<div id="dashboardPage">
    <header>
        <div class="header-brand">
            <img src="phi.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
            <b>MONITORING PRODUKSI</b>
        </div>
        <nav>
            <span id="clock" style="font-family: monospace; color: #fbbf24; font-size: 1.2rem;">--:--:--</span>
            <select id="machineSelect">
                <option value="machine01">Machine 01</option>
                <option value="machine02">Machine 02</option>
                <option value="machine03">Machine 03</option>
                <option value="machine04">Machine 04</option>
                <option value="machine05">Machine 05</option>
                <option value="machine06">Machine 06</option>
            </select>
            <button onclick="switchView('dashboard')">Dash</button>
            <button onclick="switchView('history')">Hist</button>
            <button class="btn-save" onclick="manualSave()">Save</button>
            <button class="btn-reset" onclick="resetCounter()">Reset</button>
            <button onclick="logout()">Exit</button>
        </nav>
    </header>

    <div class="container" id="viewDashboard">
        <div class="total-box">
            <div>TOTAL PRODUKSI HARI INI</div>
            <h1 id="totalCount">0</h1>
            
            <div class="setting-box">
                <span>Jadwal Auto Reset:</span>
                <input type="number" id="setHour" min="0" max="23" value="14"> :
                <input type="number" id="setMin" min="0" max="59" value="50">
                <span id="autoStatus" class="status-blink">AKTIF</span>
            </div>
            <div style="font-size: 12px; margin-top: 5px; color: #94a3b8;">*Pastikan browser tetap terbuka pada jam tersebut</div>
        </div>

        <div class="grid" id="cardsContainer"></div>
    </div>

    <div class="container" id="viewHistory" style="display:none">
        <h2 style="color:var(--primary)">History Data</h2>
        <div class="table-responsive">
            <table class="full-table">
                <thead><tr><th>Waktu</th><th>Total</th><th>Detail</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="container" id="viewSensorHistory" style="display:none">
        <h2 style="color:var(--primary)" id="sensorHistoryTitle">Detail Line</h2>
        <button onclick="switchView('dashboard')" style="margin-bottom:10px">Kembali</button>
        <div class="table-responsive">
            <table class="full-table">
                <thead><tr><th>Waktu</th><th>Nilai</th></tr></thead>
                <tbody id="sensorHistoryBody"></tbody>
            </table>
        </div>
    </div>

    <footer>
        MQTT: <span id="mqttStatus" style="color:yellow">...</span> | 
        Firebase: <span id="firebaseStatus" style="color:yellow">...</span>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAcA7CYQqoig7eVaMbopIQpq9EWn1mVudA",
        authDomain: "iot-phi.firebaseapp.com",
        databaseURL: "https://iot-phi-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "iot-phi",
        storageBucket: "iot-phi.firebasestorage.app",
        messagingSenderId: "284686032428",
        appId: "1:284686032428:web:82bec581d6c9d1a3193b89"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // --- VARIABLES ---
    let latestCounter = {};
    let globalStartTime = null; 
    const rates = Array(14).fill(70);
    let resetDoneToday = false; // Flag pengunci reset

    // --- AUTH ---
    window.doLogin = () => {
        if(document.getElementById("username").value === "admin" && 
           document.getElementById("password").value === "admin123") {
            sessionStorage.setItem("login", "1");
            location.reload();
        } else {
            document.getElementById("error").innerText = "Login Salah!";
        }
    };
    window.logout = () => { sessionStorage.clear(); location.reload(); };

    // --- ONLOAD ---
    window.onload = () => {
        if(sessionStorage.getItem("login") === "1") {
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("dashboardPage").style.display = "block";
            
            generateCards();
            syncGlobalStartTime();
            loadCache();

            // PENTING: Interval 1 detik
            setInterval(loopSystem, 1000); 
        }
    };

    // --- MQTT ---
    const client = mqtt.connect("wss://c836c913dd894d7db71ce06137b51f4e.s1.eu.hivemq.cloud:8884/mqtt", {
        username: "adminphi123", password: "Phi12345", reconnectPeriod: 2000
    });

    client.on("connect", () => {
        document.getElementById("mqttStatus").innerText = "Connected";
        document.getElementById("mqttStatus").style.color = "#22c55e";
        for(let i=1; i<=6; i++) client.subscribe(`iot/esp32/machine0${i}/counter`);
    });

    client.on("message", (topic, msg) => {
        try {
            const data = JSON.parse(msg.toString());
            const machine = topic.split('/')[2];
            // Abaikan jika 0 dan bukan reset web
            if(Object.values(data.counter).every(v=>v===0) && data.reset_source !== "web") return;
            
            Object.assign(latestCounter, data.counter);
            set(ref(database, `lastCache/${machine}`), data);
            
            document.getElementById("firebaseStatus").innerText = "Synced";
            document.getElementById("firebaseStatus").style.color = "#22c55e";
            updateUI();
        } catch(e) {}
    });

    // --- CORE LOOP (JALAN TIAP DETIK) ---
    function loopSystem() {
        const now = new Date();
        document.getElementById("clock").innerText = now.toLocaleTimeString();

        // 1. Ambil target waktu dari input box
        const targetH = parseInt(document.getElementById("setHour").value);
        const targetM = parseInt(document.getElementById("setMin").value);

        // 2. Cek apakah waktu cocok
        if(now.getHours() === targetH && now.getMinutes() === targetM) {
            if(!resetDoneToday) {
                console.log("TRIGGER AUTO RESET!");
                executeSaveAndReset();
                resetDoneToday = true; // Kunci agar tidak 2x
            }
        } else {
            resetDoneToday = false; // Buka kunci jika menit sudah lewat
        }
    }

    // --- RESET FUNCTION ---
    async function executeSaveAndReset() {
        // Bunyikan suara bip (opsional, visual saja)
        document.body.style.backgroundColor = "#451a03"; // Flash merah sebentar
        setTimeout(()=> document.body.style.backgroundColor = "#0f172a", 500);

        const entry = {
            time: new Date().toLocaleString(),
            total: document.getElementById("totalCount").innerText,
            counter: { ...latestCounter },
            type: "AUTO_RESET"
        };

        try {
            // 1. Simpan DB
            await push(ref(database, 'history'), entry);
            
            // 2. MQTT Reset Command
            for (let i = 1; i <= 6; i++) {
                client.publish(`iot/esp32/machine0${i}/cmd`, JSON.stringify({ cmd: "RESET", reset_source: "web" }));
            }

            // 3. Reset Global Time
            await set(ref(database, 'config/productionStartTime'), Date.now());

            // 4. Paksa Nol di Layar
            latestCounter = {}; 
            for(let i=1; i<=14; i++) latestCounter[`L${i}`] = 0;
            
            // 5. Paksa Nol di Cache Firebase
            for(let i=1; i<=6; i++) {
                const z = {}; for(let j=1; j<=14; j++) z[`L${j}`] = 0;
                set(ref(database, `lastCache/machine0${i}/counter`), z);
            }

            updateUI();
            alert("AUTO RESET & SAVE SUCCESS!"); // Alert muncul

        } catch (error) {
            console.error(error);
            alert("AUTO RESET FAILED: " + error.message);
        }
    }

    // --- UI UPDATER ---
    function syncGlobalStartTime() {
        onValue(ref(database, 'config/productionStartTime'), (snap) => {
            if(snap.val()) { globalStartTime = snap.val(); updateUI(); }
            else { const n = Date.now(); set(ref(database, 'config/productionStartTime'), n); globalStartTime = n; }
        });
    }

    function updateUI() {
        if (!globalStartTime) return; 
        let grandTotal = 0;
        const minElapsed = (Date.now() - globalStartTime) / 60000;

        for (let i = 1; i <= 14; i++) {
            const actual = latestCounter[`L${i}`] || 0;
            const pred = Math.max(0, Math.round(rates[i-1] * minElapsed));
            const eff = pred > 0 ? ((actual / pred) * 100).toFixed(1) : 0;
            
            if(document.getElementById(`L${i}`)) {
                document.getElementById(`L${i}`).innerText = actual;
                document.getElementById(`P${i}`).innerText = pred;
                document.getElementById(`E${i}`).innerText = eff + '%';
                document.getElementById(`E${i}`).style.color = eff < 80 ? "#ef4444" : "#22c55e";
            }
            grandTotal += actual;
        }
        document.getElementById("totalCount").innerText = grandTotal.toLocaleString();
    }

    // --- HELPERS ---
    window.manualSave = () => { if(confirm("Save & Reset Now?")) executeSaveAndReset(); };
    window.resetCounter = () => { 
        const m = document.getElementById("machineSelect").value;
        if(confirm(`Reset ${m} only?`)) client.publish(`iot/esp32/${m}/cmd`, JSON.stringify({ cmd: "RESET", reset_source: "web" }));
    };

    async function loadCache() {
        const s = await get(ref(database, 'lastCache'));
        if(s.exists()) {
            const d = s.val();
            Object.keys(d).forEach(k => { if(d[k].counter) Object.assign(latestCounter, d[k].counter); });
            updateUI();
        }
    }

    window.switchView = (v) => {
        ['dashboard','history','sensor'].forEach(t => document.getElementById('view'+t.charAt(0).toUpperCase()+t.slice(1)).style.display = 'none');
        document.getElementById('view'+v.charAt(0).toUpperCase()+v.slice(1)).style.display = 'block';
        if(v==='history') loadHistoryTable();
    };

    async function loadHistoryTable() {
        const b = document.getElementById("historyTableBody");
        b.innerHTML = "<tr><td colspan='3'>Loading...</td></tr>";
        const s = await get(ref(database, 'history'));
        b.innerHTML = "";
        if(s.exists()) Object.values(s.val()).reverse().forEach(h => {
            b.innerHTML += `<tr><td>${h.time}</td><td>${h.total}</td><td>${JSON.stringify(h.counter).substr(0,40)}...</td></tr>`;
        });
    }

    window.showSensorHistory = async (id) => {
        window.switchView('sensor');
        document.getElementById("sensorHistoryTitle").innerText = "LINE "+id;
        const b = document.getElementById("sensorHistoryBody"); b.innerHTML = "Loading...";
        const s = await get(ref(database, 'history')); b.innerHTML="";
        if(s.exists()) Object.values(s.val()).reverse().forEach(h => {
            b.innerHTML += `<tr><td>${h.time}</td><td>${h.counter[`L${id}`]||0}</td></tr>`;
        });
    }

    function generateCards() {
        const c = document.getElementById("cardsContainer"); c.innerHTML="";
        for(let i=1;i<=14;i++) c.innerHTML+=`<div class="card" onclick="showSensorHistory(${i})"><div class="card-header"><span>LINE ${i}</span><span style="font-size:12px">70cpm</span></div><table class="mini-table"><tr><th>Act</th><th>Pred</th><th>Eff</th></tr><tr><td class="val-actual" id="L${i}">0</td><td id="P${i}">0</td><td id="E${i}">0%</td></tr></table></div>`;
    }
</script>
</body>
</html>