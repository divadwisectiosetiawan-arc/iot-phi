<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pasific Harvest - IoT</title>
    
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Warna Tema Utama (Dark Blue Navy - Mirip Screenshot) */
            --bg-app: #0b1121; 
            --bg-card: #151e32; 
            --bg-nav: #0f172a;
            --border-color: #2d3748;
            
            --text-white: #ffffff;
            --text-grey: #94a3b8;
            --text-label: #64748b;
            
            --primary: #3b82f6; /* Biru badge */
            --accent: #fbbf24;  /* Kuning jam */
            
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #a855f7;
        }

        /* Light Mode Overrides */
        [data-theme="light"] {
            --bg-app: #f1f5f9;
            --bg-card: #ffffff;
            --bg-nav: #ffffff;
            --border-color: #e2e8f0;
            --text-white: #0f172a; /* Jadi hitam */
            --text-grey: #64748b;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-white);
            transition: 0.3s;
            padding-bottom: 80px; /* Space untuk bottom nav di HP */
        }

        /* --- 1. LOGIN PAGE --- */
        #loginPage {
            height: 100vh; width: 100%; position: fixed; top: 0; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            background: var(--bg-app);
        }
        .login-box {
            background: var(--bg-card); padding: 30px; width: 85%; max-width: 400px;
            border-radius: 12px; text-align: center; border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .login-box input {
            width: 100%; padding: 12px; margin-bottom: 15px; background: var(--bg-app);
            border: 1px solid var(--border-color); color: var(--text-white); border-radius: 6px;
        }
        .login-box button {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 6px; font-weight: bold; cursor: pointer;
        }

        /* --- 2. HEADER & NAVIGATION --- */
        header {
            background: var(--bg-card);
            padding: 12px 16px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        .header-brand { display: flex; align-items: center; gap: 12px; }
        .header-logo { height: 38px; width: auto; border-radius: 50%; background: white; padding: 2px; }
        .header-text h1 { margin: 0; font-size: 14px; font-weight: 900; letter-spacing: 0.5px; text-transform: uppercase; }
        .header-text p { margin: 0; font-size: 10px; color: var(--text-grey); }
        .header-clock { font-family: monospace; font-size: 14px; font-weight: bold; color: var(--accent); }

        /* Desktop Nav Buttons (Hidden on Mobile) */
        .desktop-nav { display: flex; gap: 10px; align-items: center; }
        .desktop-nav button, .desktop-nav select {
            padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color);
            background: var(--bg-app); color: var(--text-white); cursor: pointer; font-size: 12px;
        }

        /* Mobile Menu Toggle (Hidden on Desktop) */
        .mobile-menu-btn { display: none; font-size: 24px; cursor: pointer; color: var(--text-white); margin-left: 10px; }

        /* --- 3. MAIN CONTENT --- */
        .container { padding: 16px; max-width: 1200px; margin: 0 auto; }

        /* TABS LOGIC (Untuk Mobile) */
        .tab-content { display: none; animation: fadeEffect 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        /* --- 4. CARD DESIGN (MOBILE STYLE) --- */
        .grid-container {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Responsive Grid */
            gap: 15px;
        }

        .machine-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            display: flex; flex-direction: column; gap: 15px;
            position: relative; overflow: hidden;
        }
        /* Efek hover di desktop */
        .machine-card:hover { transform: translateY(-2px); border-color: var(--primary); transition: 0.2s; }

        .mc-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px;
        }
        .mc-title { font-size: 16px; font-weight: 700; letter-spacing: 1px; }
        .mc-badge {
            font-size: 10px; font-weight: 600; padding: 3px 6px; border-radius: 4px;
            background: rgba(59, 130, 246, 0.15); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .mc-badge.pouch { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border-color: rgba(245, 158, 11, 0.3); }
        .mc-cpm { font-size: 12px; font-weight: 600; color: var(--text-grey); }

        .mc-body { display: grid; grid-template-columns: 1fr 1fr 1fr; text-align: center; }
        /* Alignment agar rapi */
        .mc-stat:first-child { text-align: left; } 
        .mc-stat:last-child { text-align: right; }
        
        .stat-label { font-size: 10px; font-weight: 600; color: var(--text-label); margin-bottom: 4px; text-transform: uppercase; }
        .stat-val { font-size: 20px; font-weight: 700; color: var(--text-white); }

        /* --- 5. TOTALS & CHART STYLE --- */
        .summary-box {
            background: var(--bg-card); border: 1px solid var(--border-color);
            padding: 20px; border-radius: 12px; margin-bottom: 15px;
        }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed var(--border-color); padding-bottom: 5px; }
        
        /* --- 6. BOTTOM NAV (MOBILE ONLY) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 65px;
            background: var(--bg-nav); border-top: 1px solid var(--border-color);
            display: none; /* Hidden on Desktop */
            justify-content: space-around; align-items: center; z-index: 999;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-grey); font-size: 10px; background: none; border: none; width: 100%; height: 100%; gap: 4px;
        }
        .nav-item svg { width: 22px; height: 22px; fill: currentColor; }
        .nav-item.active { color: var(--primary); }
        
        /* --- 7. SETTINGS MODAL (MOBILE) --- */
        .mobile-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;
        }
        .settings-card { background: var(--bg-card); padding: 20px; border-radius: 12px; width: 80%; }
        .settings-card button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 6px; border: none; color: white; font-weight: bold; }

        /* --- MEDIA QUERIES (RESPONSIVE MAGIC) --- */
        @media (max-width: 768px) {
            /* Saat di HP: */
            .desktop-nav { display: none; } /* Sembunyikan menu desktop */
            .mobile-menu-btn { display: block; } /* Tampilkan menu titik tiga */
            .bottom-nav { display: flex; } /* Tampilkan nav bawah */
            
            /* Pada HP, kita gunakan sistem TAB. Jadi sembunyikan container yang tidak aktif */
            .desktop-layout-only { display: none !important; } 
            
            /* Grid di HP jadi 1 kolom */
            .grid-container { grid-template-columns: 1fr; }
        }

        @media (min-width: 769px) {
            /* Saat di Desktop: */
            .tab-content { display: block !important; } /* Tampilkan semua konten (tidak perlu tab) */
            /* Kita bisa mengatur layout desktop grid disini jika mau lebih kompleks */
            #view-totals, #view-grafik { margin-top: 30px; }
        }
    </style>
</head>

<body>

<div id="loginPage">
    <div class="login-box">
        <img src="phi.png" alt="Logo" style="height:60px; margin-bottom:20px;">
        <h3>SYSTEM LOGIN</h3>
        <input id="username" placeholder="Username" type="text">
        <input id="password" type="password" placeholder="Password">
        <button onclick="doLogin()">MASUK</button>
        <p id="error" style="color:var(--danger); margin-top:10px; font-size:12px;"></p>
    </div>
</div>

<div id="dashboardPage" style="display:none;">
    
    <header>
        <div class="header-brand">
            <img src="phi.png" alt="Logo" class="header-logo">
            <div class="header-text">
                <h1>PASIFIC HARVEST</h1>
                <p>INTEGRATED IOT SYSTEM</p>
            </div>
        </div>

        <div class="desktop-nav">
            <span id="clockDesktop" class="header-clock">00:00:00</span>
            <select id="machineSelectDesktop">
                <option value="machine01|L1">Line 01</option>
                <option value="machine02|L2">Line 02</option>
                <option value="machine03|L3">Line 03</option>
                <option value="machine04|L4">Line 04</option>
                <option value="machine05|L5">Line 05</option>
                <option value="machine06|L6">Line 06</option>
            </select>
            <button onclick="manualSave()" style="background:var(--success)">Save</button>
            <button onclick="resetCounter()" style="background:var(--danger)">Reset</button>
            <button onclick="exportToExcel()" style="background:#10b981">Excel</button>
            <button onclick="toggleTheme()">Theme</button>
            <button onclick="logout()">Logout</button>
        </div>

        <div style="display:flex; align-items:center; gap:10px;" class="mobile-only-header">
            <span id="clockMobile" class="header-clock" style="display:block; @media(min-width:769px){display:none}">00.00</span>
            <div class="mobile-menu-btn" onclick="toggleSettings(true)">â‹®</div>
        </div>
    </header>

    <div class="container">
        
        <div id="tab-dashboard" class="tab-content active">
            <div class="summary-box" style="padding:15px; display:flex; justify-content:space-between; align-items:center; background: linear-gradient(90deg, var(--bg-card), var(--bg-app)); border:1px solid var(--primary);">
                <span style="font-size:12px; color:var(--text-grey)">REALTIME TOTAL</span>
                <span id="totalDisplay" style="font-size:24px; font-weight:900; color:var(--primary)">0</span>
            </div>

            <div id="cardsContainer" class="grid-container"></div>
        </div>

        <div id="tab-totals" class="tab-content">
            <h4 style="color:var(--text-grey); margin: 20px 0 10px;">PRODUCTION SUMMARY</h4>
            
            <div class="summary-box" style="border-left: 4px solid var(--primary)">
                <div style="color:var(--primary); font-weight:bold; margin-bottom:10px;">CLUB CAN (Line 1-4, 7-14)</div>
                <div class="summary-row"><span>Actual</span><span id="totalClubActual">0</span></div>
                <div class="summary-row"><span>Prediction</span><span id="totalClubPrediction">0</span></div>
                <div class="summary-row"><span>Efficiency</span><span id="totalClubEff">0%</span></div>
            </div>

            <div class="summary-box" style="border-left: 4px solid var(--warning)">
                <div style="color:var(--warning); font-weight:bold; margin-bottom:10px;">POUCH CAN (Line 5-6)</div>
                <div class="summary-row"><span>Actual</span><span id="totalPouchActual">0</span></div>
                <div class="summary-row"><span>Prediction</span><span id="totalPouchPrediction">0</span></div>
                <div class="summary-row"><span>Efficiency</span><span id="totalPouchEff">0%</span></div>
            </div>

            <div class="summary-box" style="border-left: 4px solid var(--purple)">
                <div style="color:var(--purple); font-weight:bold; margin-bottom:10px;">GRAND TOTAL</div>
                <div class="summary-row"><span>Total Actual</span><span id="grandTotalActual" style="font-size:18px; font-weight:bold">0</span></div>
                <div class="summary-row"><span>Total Prediction</span><span id="grandTotalPrediction">0</span></div>
                <div class="summary-row"><span>Avg Efficiency</span><span id="grandTotalEff">0%</span></div>
            </div>
        </div>

        <div id="tab-grafik" class="tab-content">
            <div class="summary-box">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <span style="font-weight:bold">CHART</span>
                    <div style="display:flex; gap:5px;">
                        <button onclick="updateChartPeriod('daily', this)" style="font-size:10px; padding:4px 8px; border-radius:10px; border:none; background:var(--primary); color:white;">Day</button>
                        <button onclick="updateChartPeriod('weekly', this)" style="font-size:10px; padding:4px 8px; border-radius:10px; border:none; background:var(--bg-nav); color:grey;">Week</button>
                    </div>
                </div>
                <div style="height:300px;"><canvas id="productionChart"></canvas></div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchMobileTab('dashboard', this)">
            <svg viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
            <span>DASHBOARD</span>
        </button>
        <button class="nav-item" onclick="switchMobileTab('totals', this)">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9h-2V7h2v5zm4 0h-2V7h2v5zm-2 6H8v-4h6v4z"/></svg>
            <span>TOTALS</span>
        </button>
        <button class="nav-item" onclick="switchMobileTab('grafik', this)">
            <svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
            <span>GRAFIK</span>
        </button>
    </nav>

    <div id="mobileSettings" class="mobile-overlay">
        <div class="settings-card">
            <h3 style="margin-top:0; color:var(--text-white); border-bottom:1px solid var(--border-color); padding-bottom:10px;">MENU</h3>
            
            <label style="font-size:12px; color:grey;">Pilih Mesin:</label>
            <select id="machineSelectMobile" style="width:100%; padding:10px; margin-bottom:15px; background:var(--bg-app); color:white; border:1px solid var(--border-color);">
                <option value="machine01|L1">Line 01</option>
                <option value="machine02|L2">Line 02</option>
                <option value="machine03|L3">Line 03</option>
                <option value="machine04|L4">Line 04</option>
                <option value="machine05|L5">Line 05</option>
                <option value="machine06|L6">Line 06</option>
            </select>

            <button onclick="manualSave()" style="background:var(--success)">Simpan Data</button>
            <button onclick="resetCounterMobile()" style="background:var(--danger)">Reset Line</button>
            <button onclick="exportToExcel()" style="background:#10b981">Download Excel</button>
            <button onclick="toggleTheme()" style="background:var(--purple)">Ganti Tema</button>
            <button onclick="logout()" style="background:var(--bg-nav); border:1px solid var(--border-color);">Logout</button>
            
            <div onclick="toggleSettings(false)" style="text-align:center; margin-top:15px; color:var(--danger); cursor:pointer;">Tutup</div>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAcA7CYQqoig7eVaMbopIQpq9EWn1mVudA",
        authDomain: "iot-phi.firebaseapp.com",
        databaseURL: "https://iot-phi-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "iot-phi",
        storageBucket: "iot-phi.firebasestorage.app",
        messagingSenderId: "284686032428",
        appId: "1:284686032428:web:82bec581d6c9d1a3193b89"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // --- VARIABLES ---
    let latestCounter = {};
    let globalStartTime = null; 
    let manualOffset = 0; 
    let hasAutoSaved = false; 
    const rates = Array(14).fill(70); 
    let myChart = null;
    let historyDataCache = [];

    // --- HELPER UI ---
    const getVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();

    // --- TAB SWITCHER (MOBILE ONLY) ---
    window.switchMobileTab = (tabName, btn) => {
        // Hanya jalan jika di layar kecil (mobile)
        if(window.innerWidth <= 768) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
        }
    };

    // --- SETTINGS MODAL ---
    window.toggleSettings = (show) => {
        document.getElementById('mobileSettings').style.display = show ? 'flex' : 'none';
    };

    window.toggleTheme = () => {
        const html = document.documentElement;
        const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        html.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        if(myChart) myChart.update();
    };
    document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');

    // --- CLOCK ---
    setInterval(() => {
        const d = new Date();
        const t = d.toLocaleTimeString('id-ID', {hour12:false}).replace(/:/g, '.'); // Format 16.37.41
        document.getElementById('clockDesktop').innerText = t;
        document.getElementById('clockMobile').innerText = t;
    }, 1000);

    /* --- LOGIC UTAMA --- */
    window.doLogin = () => {
        if(document.getElementById("username").value === "admin" && document.getElementById("password").value === "admin123") {
            sessionStorage.setItem("login", "1"); location.reload();
        } else { document.getElementById("error").innerText = "Login Gagal!"; }
    };
    window.logout = () => { sessionStorage.clear(); location.reload(); };

    window.onload = () => {
        if(sessionStorage.getItem("login") === "1") {
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("dashboardPage").style.display = "block";
            
            generateAllCards(); 
            syncConfig(); 
            loadLastCacheFromFirebase(); 
            fetchHistoryForChart();
            
            setInterval(checkAutoSchedule, 10000);
            setInterval(updateUI, 1000);
        }
    };

    /* --- UI GENERATION (THE CORE CHANGE) --- */
    function generateAllCards() {
        const container = document.getElementById("cardsContainer");
        container.innerHTML = "";

        for(let i=1; i<=14; i++) {
            const isP = (i===5||i===6);
            const badge = isP ? "POUCHCAN" : "CLUBCAN";
            const badgeClass = isP ? "pouch" : "";
            
            // Layout Kartu Baru (Mirip Screenshot)
            const html = `
            <div class="machine-card">
                <div class="mc-header">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="mc-title">LINE ${i.toString().padStart(2,'0')}</span>
                        <span class="mc-badge ${badgeClass}">${badge}</span>
                    </div>
                    <span class="mc-cpm">${rates[i-1]} CPM</span>
                </div>
                <div class="mc-body">
                    <div class="mc-stat">
                        <div class="stat-label">ACTUAL</div>
                        <div class="stat-val" id="L${i}">0</div>
                    </div>
                    <div class="mc-stat">
                        <div class="stat-label">PREDICT</div>
                        <div class="stat-val" id="P${i}">0</div>
                    </div>
                    <div class="mc-stat">
                        <div class="stat-label">EFF %</div>
                        <div class="stat-val" id="E${i}">0%</div>
                    </div>
                </div>
            </div>`;
            container.innerHTML += html;
        }
    }

    /* --- DATA LOGIC --- */
    function updateUI() {
        if(!globalStartTime) return;
        const mins = Math.max(0, Date.now() - globalStartTime) / 60000;
        
        let gTot=0, cAct=0, cPred=0, pAct=0, pPred=0;

        for(let i=1; i<=14; i++) {
            const act = latestCounter[`L${i}`] || 0;
            const pred = Math.floor(rates[i-1] * mins);
            const eff = pred>0 ? ((act/pred)*100).toFixed(0)+'%' : '0%';
            
            const isP = (i===5||i===6);
            if(isP) { pAct+=act; pPred+=pred; } else { cAct+=act; cPred+=pred; }
            
            // Update Card
            const elL = document.getElementById(`L${i}`);
            if(elL) {
                elL.innerText = act; 
                document.getElementById(`P${i}`).innerText = pred; 
                const eEl = document.getElementById(`E${i}`);
                eEl.innerText = eff;
                eEl.style.color = parseFloat(eff)>=90 ? getVar('--success') : getVar('--danger');
            }
            gTot+=act;
        }
        
        const finalTotal = gTot + manualOffset;
        
        // Update di kedua tempat (Header & Totals Tab)
        document.getElementById("totalDisplay").innerText = finalTotal.toLocaleString(); 
        
        // Update Summary Arrays
        updateSum('totalClub', cAct, cPred);
        updateSum('totalPouch', pAct, pPred);
        updateSum('grandTotal', finalTotal, cPred+pPred);
    }

    function updateSum(id, act, pred) {
        document.getElementById(`${id}Actual`).innerText = act.toLocaleString();
        document.getElementById(`${id}Prediction`).innerText = pred.toLocaleString();
        const eff = pred>0 ? ((act/pred)*100).toFixed(0)+'%' : '0%';
        document.getElementById(`${id}Eff`).innerText = eff;
    }

    /* --- RESET & DATA --- */
    window.resetCounter = async () => {
        const val = document.getElementById("machineSelectDesktop").value; // Ambil dari desktop select
        processReset(val);
    };
    
    // Fungsi khusus untuk tombol reset di mobile modal
    window.resetCounterMobile = async () => {
        const val = document.getElementById("machineSelectMobile").value; // Ambil dari mobile select
        processReset(val);
        toggleSettings(false); // Tutup modal
    };

    async function processReset(val) {
        const [mach, line] = val.split("|");
        if(confirm(`Reset ${line}?`)) {
            const curr = latestCounter[line] || 0;
            await set(ref(database, 'config/manualOffset'), manualOffset + curr);
            client.publish(`iot/esp32/${mach}/cmd`, JSON.stringify({cmd:"RESET", reset_source:"web"}));
        }
    }

    function checkAutoSchedule() {
        const d = new Date();
        if(d.getHours()===15 && d.getMinutes()===10 && !hasAutoSaved) { executeSaveAndReset(); hasAutoSaved=true; }
        else if(d.getMinutes()!==10) hasAutoSaved=false;
    }

    async function executeSaveAndReset() {
        let act = manualOffset, pred = 0;
        if(globalStartTime) {
            const mins = Math.max(0, Date.now() - globalStartTime) / 60000;
            for(let i=1; i<=14; i++) { act += (latestCounter[`L${i}`]||0); pred += Math.floor(rates[i-1]*mins); }
        }
        await push(ref(database, 'history'), { time: new Date().toLocaleString('id-ID'), timestamp: Date.now(), total: act, totalPrediction: pred, counter: {...latestCounter} });
        for(let i=1; i<=6; i++) client.publish(`iot/esp32/machine0${i}/cmd`, JSON.stringify({cmd:"RESET", reset_source:"web"}));
        await set(ref(database, 'config/productionStartTime'), Date.now());
        await set(ref(database, 'config/manualOffset'), 0);
        latestCounter={}; fetchHistoryForChart(); updateUI();
    }
    
    window.manualSave = () => { if(confirm("Simpan & Reset Akhir Shift?")) executeSaveAndReset(); };

    /* --- EXCEL --- */
    window.exportToExcel = () => {
        if (historyDataCache.length === 0) return alert("No Data");
        let csv = "\uFEFFWaktu;Total;Pred"; for(let i=1;i<=14;i++) csv+=`;L${i}`; csv+="\n";
        [...historyDataCache].reverse().forEach(h => {
            let row = `"${h.time.replace(/,/g,'')}";${h.total};${h.totalPrediction}`;
            for(let i=1;i<=14;i++) row+=`;${h.counter?h.counter[`L${i}`]||0:0}`;
            csv+=row+"\n";
        });
        const a = document.createElement("a"); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = `Log_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    };

    /* --- CHART --- */
    window.updateChartPeriod = (p,b) => { processAndRenderChart(p); };
    async function fetchHistoryForChart() {
        const snap = await get(ref(database, 'history'));
        if(snap.exists()) { historyDataCache = Object.values(snap.val()); processAndRenderChart('daily'); }
    }
    function processAndRenderChart(period) {
        if(historyDataCache.length===0) return;
        const grouped={}; const months=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
        historyDataCache.forEach(e => {
            let d = e.timestamp ? new Date(e.timestamp) : new Date();
            let k = period==='daily' ? d.toLocaleDateString('id-ID',{day:'numeric',month:'short'}) : (period==='weekly' ? `W${Math.ceil((d.getDate()+(new Date(d.getFullYear(),d.getMonth(),1)).getDay())/7)}` : months[d.getMonth()]);
            if(!grouped[k]) grouped[k]={act:0,pred:0};
            grouped[k].act+=e.total||0; grouped[k].pred+=(e.totalPrediction||e.total);
        });
        const k = Object.keys(grouped);
        renderChart(k, k.map(x=>grouped[x].act), k.map(x=>grouped[x].pred));
    }
    function renderChart(l, a, p) {
        const ctx = document.getElementById('productionChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            data: { labels: l, datasets: [
                { type:'line', label:'Target', data:p, borderColor:'#fbbf24', borderWidth:2, pointRadius:0 },
                { type:'bar', label:'Actual', data:a, backgroundColor: c=>c.raw>=p[c.dataIndex]?'#22c55e':'#ef4444' }
            ]},
            options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ticks:{stepSize:1000, color:'#94a3b8', callback:v=>v>=1000?(v/1000).toFixed(0)+'k':v}, grid:{color:'#2d3748'}}, x:{grid:{display:false}, ticks:{color:'#94a3b8'}} }, plugins:{legend:{display:false}} }
        });
    }

    /* --- MQTT & FIREBASE --- */
    function syncConfig() {
        onValue(ref(database, 'config/productionStartTime'), (s) => { const v=s.val(); if(v){globalStartTime=v;updateUI();}else{set(ref(database,'config/productionStartTime'),Date.now())} });
        onValue(ref(database, 'config/manualOffset'), (s) => { manualOffset=s.val()||0; updateUI(); });
    }
    async function loadLastCacheFromFirebase() {
        const snap = await get(ref(database, 'lastCache'));
        if(snap.exists()) { Object.keys(snap.val()).forEach(m => { if(snap.val()[m].counter) Object.assign(latestCounter, snap.val()[m].counter); }); updateUI(); }
    }
    const client = mqtt.connect("wss://c836c913dd894d7db71ce06137b51f4e.s1.eu.hivemq.cloud:8884/mqtt", { username: "adminphi123", password: "Phi12345", reconnectPeriod: 2000 });
    client.on("connect", () => { for(let i=1; i<=6; i++) client.subscribe(`iot/esp32/machine0${i}/counter`); });
    client.on("message", (t, m) => {
        try {
            const d = JSON.parse(m.toString()); const mach = t.split('/')[2];
            Object.assign(latestCounter, d.counter);
            set(ref(database, `lastCache/${mach}`), d);
            updateUI();
        } catch(e) {}
    });
</script>
</body>
</html>.